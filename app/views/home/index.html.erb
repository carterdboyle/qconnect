<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>QConnect: Registration MVP</title>
</head>
<body>
  <script type="module">
    import { initOQS, diliKeypair, kyberKeypair, diliSign, kyberDecaps } from "/pq/oqsClient.js";

    const b64u = (u) => btoa(String.fromCharCode(...u)).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
    const unb64u = (s) => new Uint8Array(atob(s.replace(/-/g, '+').replace(/_/g, '/')).split('').map(c => c.charCodeAt(0)));
    const enc = (s) => new TextEncoder().encode(s);

    (async () => {
      await initOQS();

      // 1) client-side keygen
      const [ps, ss] = await diliKeypair();
      const [pk, sk] = await kyberKeypair();

      // 2) register init
      const initRes = await fetch("/v1/register/init", {
        method: "POST",
        headers: { "Content-Type": "application/json"}, 
        body: JSON.stringify({ handle: "browser_user", ps: b64u(ps), pk: b64u(pk) })
      }).then(r => r.json());

      const userId = initRes.user_id;
      const M = unb64u(initRes.m);
      const C = unb64u(initRes.c);

      // 3) Client decapsulates (with the real Kyber, this derives "K")
      // For the minimal viable here its C is (K XOR 0xAA), so we reverse-xor here for a match.
      // TODO: Replace this with: Const Kp = await kyberDecaps(sk, C); oncse server uses real Kyber encaps.
      const Kp = new Uint8Array(C.length);
      for (let i=0; i < C.length; i++ ) Kp[i] = C[i] ^ 0xAA;

      // 4) client signs M (we won't verify server-side yet, but it proves the browser did the op)
      const S = await diliSign(ss, M);

      const verifyRes = await fetch("/v1/register/verify", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ user_id: userId, s: b64u(S), k_prime: b64u(Kp) })
      }).then(r=>r.json());

      console.log("Registration verify:", verifyRes);
      const p = document.createElement("pre");
      p.textContent = JSON.stringify(verifyRes, null, 2);
      document.body.appendChild(p);
    })();
  </script>
</body>
</html>