<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>QConnect: Registration MVP</title>
</head>
<body>
  <script type="module">
    import { initOQS, diliKeypair, kyberKeypair, diliSign, kyberDecaps, deriveKPrimeFromSS } from "/pq/oqsClient.js";

    const b64u = (u) => btoa(String.fromCharCode(...u)).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
    const unb64u = (s) => new Uint8Array(atob(s.replace(/-/g, '+').replace(/_/g, '/')).split('').map(c => c.charCodeAt(0)));
    const enc = (s) => new TextEncoder().encode(s);

    (async () => {
      await initOQS();

      // await probeClientKemAlgorithms();
      const hex = (u8) => [...u8].map(b => b.toString(16).padStart(2, '0')).join('');

      // 1) client-side keygen
      const [ps, ss] = await diliKeypair();
      const [pk, sk] = await kyberKeypair();

      // 2) register init
      const initRes = await fetch("/v1/register/init", {
        method: "POST",
        headers: { "Content-Type": "application/json"}, 
        body: JSON.stringify({ handle: "browser_user", ps_b64: b64u(ps), pk_b64: b64u(pk) })
      }).then(r => r.json());

      // const { m_b64, ct_b64, _kem, _k_hex, _ct_len, _pk_len, _ct_sha256 } = initRes;
      const { m_b64, ct_b64 } = initRes;
      const M = unb64u(m_b64);
      const C = unb64u(ct_b64);
      // console.log("SERVER kem:", _kem, "ct.len:", _ct_len, "pk.len:", _pk_len);
      // console.log("SERVER K(hex):", _k_hex);
      // console.log("SERVER CT SHA256:", _ct_sha256);

      // 3) Client decapsulates (with the real Kyber, this derives "K")
      // For the minimal viable here its C is (K XOR 0xAA), so we reverse-xor here for a match.
      // TODO: Replace this with: Const Kp = await kyberDecaps(sk, C); once server uses real Kyber encaps.
      const ss_client = await kyberDecaps(sk, C);
      // console.log("client ss.len:", ss_client.length);
      const Kp = await deriveKPrimeFromSS(ss_client);
      // console.log("CLIENT K'(hex):", hex(Kp));
      // const ctDig = await crypto.subtle.digest("SHA-256", C);
      // console.log("CLIENT CT SHA256: ", hex(new Uint8Array(ctDig)))

      // const Kp = new Uint8Array(C.length);
      // for (let i=0; i < C.length; i++ ) Kp[i] = C[i] ^ 0xAA;

      // 4) client signs with dilithium secret key
      const S = await diliSign(ss, M);

      const verifyRes = await fetch("/v1/register/verify", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ handle: "browser_user", sig_b64: b64u(S), kp_b64: b64u(Kp) })
      }).then(r=>r.json());

      console.log("Registration verify:", verifyRes);
      const p = document.createElement("pre");
      p.textContent = JSON.stringify(verifyRes, null, 2);
      document.body.appendChild(p);
    })();
  </script>
</body>
</html>